webpackJsonp([11],{llSq:function(t,e,a){"use strict";var r=a("Dd8w"),i=a.n(r),n=a("pFYg"),s=a.n(n),d=a("woOf"),o=a.n(d),u=a("Xxa5"),c=a.n(u),l=a("W3Iv"),S=a.n(l),f=a("gRE1"),p=a.n(f),z=a("exGp"),w=a.n(z),h=a("BeRe"),m={name:"WizardStep",props:{idForm:{required:!1},value:{required:!1,default:null},title:{type:String,required:!1,default:""},typeForm:{type:String,required:!1,default:"simple"},backDisabled:{type:Boolean,required:!1,default:!1},readOnly:{type:Boolean,required:!1,default:!1},readonlyState:{type:Boolean,required:!1,default:!1}},data:function(){return{values:{data:null,respostas:{}}}},beforeCreate:function(){this.$options.components.Form=a("BeRe").default},methods:{save:function(t){this.values=t,this.$emit("save",this.values)},cancel:function(t){this.values=t,this.$emit("cancel",t)}},components:{Form:h.default},beforeDestroy:function(){this.$refs&&this.$refs.subForm&&(this.$refs.subForm.$destroy(),this.$refs.subForm=null)}},v={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return t.idForm?a("Form",{ref:"subForm",attrs:{idForm:t.idForm,backDisabled:t.backDisabled,title:t.title,value:t.value,readOnly:t.readOnly,typeForm:t.typeForm,readonlyState:t.readonlyState},on:{save:t.save,input:function(e){t.$emit("input",e)},cancel:t.cancel,updatePreResp:function(e){t.$emit("updatePreResp",e)}}}):t._e()},staticRenderFns:[]},k=a("VU/8")(m,v,!1,null,null,null).exports,R=a("T75j"),b={getOneWizardResponseByIdTarefa:function(t){return R.a.getOne("wizardResponse",t)},setOne:function(t){R.b.setOne("wizardResponse",t)},deleteOne:function(t){this.getOneWizardResponseByIdTarefa(t).then(function(t){t&&t.idTarefa&&R.b.deleteOne("wizardResponse",t.idTarefa)})}},y=a("R4BC"),g=a("T8Nv"),O=a("NYxO"),_={name:"FormWizard",props:{task:{type:Object,required:!0}},data:function(){return{firstState:0,wizardId:1,wizardState:{currentState:null,currentTransition:null,checkPointTransition:null,readonlyState:!0,transitionLog:[],preResp:{},states:{}},transitions:[]}},beforeMount:function(){var t=this;return w()(c.a.mark(function e(){var a,r,i;return c.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=t,t.wizardId=0;try{t.wizardId=parseInt(p()(a.task.metaDados).find(function(t){return"__WIZARD_CODE"==t.meta_key}).meta_value),console.log("WIZARD ID TRUE",t.wizardId)}catch(e){t.wizardId=0,console.log("WIZARD ID ERROR",t.wizardId)}return e.next=5,y.a.getOneFormWizardById(t.wizardId);case 5:return r=e.sent,e.next=8,b.getOneWizardResponseByIdTarefa(t.task.id);case 8:i=e.sent,r&&i&&(0===S()(a.wizardState.states).length&&a.wizardState.states.constructor===Object&&(a.wizardState.states=r.states),a.wizardState.transitions=r.transitions,a.transitions=r.transitions,a.firstState=r.firstState,null!=i.wizardState.currentState&&void 0!==i.wizardState.currentState?a.wizardState.currentState=i.wizardState.currentState:a.wizardState.currentState=p()(r.states).find(function(t){return t.id==r.firstState})),t.loadValues();case 11:case"end":return e.stop()}},e,t)}))()},methods:{loadValues:function(){var t=this;return w()(c.a.mark(function e(){var a,r,i,n,s;return c.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t,e.next=3,b.getOneWizardResponseByIdTarefa(a.task.id);case 3:if(r=e.sent,i=t.task.metaDados.find(function(t){return"__OS"==t.meta_key}),!(r&&i&&i.meta_value)||r.wizardState.preResp.OS!=i.meta_value&&r.wizardState.preResp.nOS!=i.meta_value){e.next=15;break}return a.wizardState=r.wizardState,a.$store.dispatch("task/setDefaultPreResp",{preResp:a.wizardState.preResp}),e.next=10,y.a.getOneFormWizardById(a.wizardId);case 10:(n=e.sent)&&(0===S()(a.wizardState.states).length&&a.wizardState.states.constructor===Object&&(a.wizardState.states=n.states),a.firstState=n.firstState,null!=r.wizardState.currentState&&void 0!==r.wizardState.currentState?a.wizardState.currentState=r.wizardState.currentState:a.wizardState.currentState=p()(n.states).find(function(t){return t.id==n.firstState}),a.transitions=n.transitions),"wizardsave"==a.wizardState.currentState.type&&a.saveWizardResponses(a.wizardState.states),e.next=31;break;case 15:if(i&&r&&i.meta_value&&r.wizardState.preResp&&(r.wizardState.preResp.OS!=i.meta_value||r.wizardState.preResp.nOS!=i.meta_value)&&b.deleteOne(a.task.id),e.prev=16,s=JSON.parse(p()(a.task.metaDados).find(function(t){return"__pre_resp"==t.meta_key}).meta_value),a.wizardState.preResp=s,!(!a.wizardState.preResp||a.wizardState.preResp.OS&&a.wizardState.preResp.OS!=i.meta_value||a.wizardState.preResp.nOS&&a.wizardState.preResp.OS!=i.meta_value)){e.next=21;break}throw new Error("oops");case 21:a.$store.dispatch("task/setDefaultPreResp",{preResp:s}),e.next=28;break;case 24:e.prev=24,e.t0=e.catch(16),a.$bus.$emit("showSnackBar",{message:a.$t("OS ainda em sincronização!"),duration:3e3}),Object(g.e)(a.task.id).then(function(t){a.$bus.$emit("tasks-sync",!0),a.wizardState.preResp=t.data,a.$store.dispatch("task/setDefaultPreResp",{preResp:t.data})});case 28:return e.next=30,b.setOne({idTarefa:a.task.id,wizardState:a.wizardState});case 30:a.loadValues();case 31:case"end":return e.stop()}},e,t,[[16,24]])}))()},setState:function(t){var e=this;this.wizardState.currentTransition=t,this.wizardState.transitionLog.push(t),null==p()(e.wizardState.states).find(function(t){return t.id==e.wizardState.currentState.id}).value&&o()(p()(e.wizardState.states).find(function(t){return t.id==e.wizardState.currentState.id}),this.wizardState.currentState),this.wizardState.currentState=p()(e.wizardState.states).find(function(e){return e.id==t.destiny}),this.$bus.$emit("changeParams",{pageTitle:this.$t("Em atendimento"),mapMenu:!1,backMenu:this.wizardState.firstState==this.wizardState.currentState.id}),b.setOne({idTarefa:this.task.id,wizardState:this.wizardState}),"wizardsave"==this.wizardState.currentState.type&&this.saveWizardResponses(this.wizardState.states),"wizardconfirm"==this.wizardState.currentState.type&&this.orderStatesByTransition()},updateForm:function(t){if(this.wizardState.currentState.value=t,void 0!==this.wizardState.transitionLog.slice(-1)[0]){var e=this.wizardState.transitionLog.slice(-1)[0].destiny;p()(this.wizardState.states).find(function(t){return t.id==e}).value=t}b.setOne({idTarefa:this.task.id,wizardState:this.wizardState})},updatePreResp:function(t){this.defaultPreResp&&(this.$store.dispatch("task/updateDefaultPreResp",t),this.wizardState.preResp=this.defaultPreResp,b.setOne({idTarefa:this.task.id,wizardState:this.wizardState}))},saveForm:function(t){var e=this;for(var a in e.wizardState.currentState.value=t,p()(e.wizardState.states).find(function(t){return t.id==e.wizardState.currentState.id}).value=t,e.destinys){var r=e.destinys[a];if(null==r.value||""==r.value)return void this.setState(r);if(null!=r.field&&"object"==s()(r.field)){if(p()(e.wizardState.states).find(function(t){return t.id==r.field.state}).value.responses[r.field.id].valor==r.value)return void this.setState(r)}else if(t.responses[r.field].valor==r.value)return void this.setState(r)}Object(g.e)(this.task.id).then(function(t){e.$bus.$emit("tasks-sync",!0),e.$store.dispatch("task/setDefaultPreResp",{preResp:t.data})}),e.$bus.$emit("showSnackBar",{message:e.$t("Formulário não possui valores válidos!"),duration:3e3})},aproveForm:function(){for(var t in this.destinys){this.wizardState.checkPointTransition=this.destinys[t],this.setState(this.wizardState.checkPointTransition);break}},cancelForm:function(t){var e=this;this.updateForm(t),null==this.wizardState.currentTransition||null!=this.wizardState.checkPointTransition&&this.wizardState.currentTransition.id==this.wizardState.checkPointTransition.id||(this.wizardState.currentTransition=this.wizardState.transitionLog.pop(),null!=this.wizardState.currentTransition&&(this.wizardState.currentState=p()(e.wizardState.states).find(function(t){return t.id==e.wizardState.currentTransition.origin})))},editForm:function(){var t=this;for(t.wizardState.currentTransition=t.wizardState.transitionLog.pop();null!=t.wizardState.currentTransition&&t.wizardState.transitionLog.length>0&&(null==t.wizardState.checkPointTransition||t.wizardState.currentTransition.id!=t.wizardState.checkPointTransition.id);)t.wizardState.currentTransition=t.wizardState.transitionLog.pop();null!=t.wizardState.currentTransition&&(0==t.wizardState.transitionLog.length?(t.wizardState.currentTransition=null,t.wizardState.currentState=p()(t.wizardState.states).find(function(e){return e.id==t.firstState}),t.$bus.$emit("changeParams",{pageTitle:t.$t("Em atendimento"),mapMenu:!1,backMenu:t.firstState==t.wizardState.currentState.id})):t.setState(t.wizardState.currentTransition))},renderForm:function(t){return("wizardsave"!=t.type||this.wizardState.currentState.id!=t.id)&&(null!=t.id&&t.id==this.wizardState.currentState.id||"wizardconfirm"==this.wizardState.currentState.type&&null!=t.value&&""!=t.value)},saveWizardResponses:function(t){this.$emit("wizardSaved",t)},orderStatesByTransition:function(){var t=this;if(t.wizardState.transitionLog&&t.wizardState.transitionLog.length>0){console.log("PRE ORDENACAO",t.wizardState.states);var e=[],a=[];t.wizardState.transitionLog.forEach(function(r){("object"!=s()(t.wizardState.states)?t.wizardState.states:p()(t.wizardState.states)).forEach(function(t){r.origin==t.id?e.push(t):-1===a.indexOf(t)&&a.push(t)})}),a.forEach(function(t){-1===e.indexOf(t)&&e.push(t)}),t.wizardState.states=e,console.log("POS ORDENACAO",t.wizardState.states)}}},computed:i()({},Object(O.b)({currentTask:"task/currentTask",defaultPreResp:"task/defaultPreResp"}),{destinys:function(){var t=[];for(var e in this.transitions){var a=this.transitions[e];a.origin==this.wizardState.currentState.id&&t.push(a)}return t},backDisabled:function(){return this.firstState==this.wizardState.currentState.id||null!=this.wizardState.transitionLog&&null!=this.wizardState.checkPointTransition&&this.wizardState.transitionLog[this.wizardState.transitionLog.length-1].id==this.wizardState.checkPointTransition.id}}),components:{WizardStep:k}},T={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return t.wizardState&&t.wizardState.currentState?a("div",{staticClass:"col"},[t._l(t.wizardState.states,function(e,r){return a("span",{key:r},[t.renderForm(e)?a("WizardStep",{attrs:{idForm:e.idForm,backDisabled:t.backDisabled,title:e.title,value:e.value,readOnly:t.wizardState.currentState&&"wizardconfirm"==t.wizardState.currentState.type,typeForm:e.type,readonlyState:t.wizardState.readonlyState},on:{save:t.saveForm,input:t.updateForm,cancel:t.cancelForm,updatePreResp:t.updatePreResp}}):t._e()],1)}),t._v(" "),t.wizardState.currentState&&"wizardsave"==t.wizardState.currentState.type?a("div",{staticClass:"form-actions wizardconfirm"},[t._v("\n    "+t._s(t.$t("Salvando dados.."))+"\n  ")]):t._e(),t._v(" "),t.wizardState.currentState&&"wizardconfirm"==t.wizardState.currentState.type?a("div",{staticClass:"form-actions wizardconfirm"},[a("button",{staticClass:"mdl-button  button-edit",on:{click:t.editForm}},[a("i",{staticClass:"material-icons"},[t._v("close")]),t._v(t._s(t.$t("Alterar"))+"\n    ")]),t._v(" "),a("button",{staticClass:"mdl-button  button-confirm ",on:{click:t.aproveForm}},[t._v(t._s(t.$t("Aprovar"))),a("i",{staticClass:"material-icons"},[t._v("check_circle_outline")])])]):t._e()],2):t._e()},staticRenderFns:[]},F=a("VU/8")(_,T,!1,null,null,null);e.a=F.exports},r5T1:function(t,e){},unOq:function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=a("BeRe"),i=a("llSq"),n=a("3KnT"),s={name:"FormPage",data:function(){return{idTask:null,idForm:null,values:[],task:{id:1}}},methods:{save:function(t){this.values=t}},beforeMount:function(){this.idForm=this.$route.params.idForm,this.idTask=this.$route.params.idTask},mounted:function(){this.$emit("changeParams",{pageTitle:this.$t("Formulário"),mapMenu:!0,backMenu:!1})},components:{Form:r.default,FormWizard:i.a,InputSku:n.a}},d={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"content-page"},[a("div",{staticClass:"task-form"},[a("div",{staticClass:"mdl-card card-conteudo col"},[a("div",{staticClass:"card-content"},[a("Form",{attrs:{idForm:t.idForm}})],1)]),t._v(" "),a("div",{staticClass:"actions"},[a("button",{staticClass:"mdl-button  mdl-button--fab  orange",on:{click:function(e){return t.$router.push("/messages")}}},[a("i",{staticClass:"material-icons message"},[t._v("message")])])])])])},staticRenderFns:[]};var o=a("VU/8")(s,d,!1,function(t){a("r5T1")},"data-v-c9edef18",null);e.default=o.exports}});
//# sourceMappingURL=11.fd3e7b22c985fa292b92.js.map